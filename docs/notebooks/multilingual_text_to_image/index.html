<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta property="og:title" content="Multilingual Text-to-Image search with MultilingualCLIP" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://finetuner.jina.ai/notebooks/multilingual_text_to_image/" />
<meta property="og:site_name" content="Finetuner Documentation" />
<meta property="og:description" content="Most text-image models are only able to provide embeddings for text in a single language, typically English. Multilingual CLIP models, however, are models that have been trained on multiple different languages. This allows the model to produce similar embeddings for the same sentence in multiple ..." />
<meta property="og:image" content="https://finetuner.jina.ai/_images/WandB-mclip.png" />
<meta property="og:image:alt" content="WandB-mclip" />
<meta name="description" content="Most text-image models are only able to provide embeddings for text in a single language, typically English. Multilingual CLIP models, however, are models that have been trained on multiple different languages. This allows the model to produce similar embeddings for the same sentence in multiple ..." />
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description" content="Finetuner is a library for tune the weights of any deep neural network for better embeddings on search tasks.">
<meta property="og:description" content="Finetuner allows one to tune the weights of any deep neural network for better embeddings on search tasks. It accompanies Jina to deliver the last mile of performance for domain-specific neural search applications.">

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1ESRNDCK35"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1ESRNDCK35');
</script>

<script async defer src="https://buttons.github.io/buttons.js"></script>
    
<link rel="index" title="Index" href="../../genindex/" /><link rel="search" title="Search" href="../../search/" /><link rel="next" title="finetuner package" href="../../api/finetuner/" /><link rel="prev" title="Text-to-Image Search via CLIP" href="../text_to_image/" />
        <link rel="canonical" href="https://finetuner.jina.ai/notebooks/multilingual_text_to_image.html" />

    <link rel="shortcut icon" href="../../_static/favicon.png"/><meta name="generator" content="sphinx-4.5.0, furo 2022.09.29"/>
        <title>Multilingual Text-to-Image search with MultilingualCLIP - Finetuner documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: #4d4d4d;
  --color-brand-primary: #009191;
  --color-brand-content: #009191;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FBCB67;
  --color-brand-content: #FBCB67;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
    <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
    <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
    <header class="mobile-header">
        <div class="header-left">
            <label class="nav-overlay-icon" for="__navigation">
                <div class="visually-hidden">Toggle site navigation sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-menu"></use>
                    </svg>
                </i>
            </label>
        </div>
        <div class="header-center">
            <a href="../../">
                <div class="brand">Finetuner  documentation</div>
            </a>
        </div>
        <div class="header-right">
            <div class="theme-toggle-container theme-toggle-header">
                <button class="theme-toggle">
                    <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                    <svg class="theme-icon-when-auto">
                        <use href="#svg-sun-half"></use>
                    </svg>
                    <svg class="theme-icon-when-dark">
                        <use href="#svg-moon"></use>
                    </svg>
                    <svg class="theme-icon-when-light">
                        <use href="#svg-sun"></use>
                    </svg>
                </button>
            </div>
            <label class="toc-overlay-icon toc-header-icon" for="__toc">
                <div class="visually-hidden">Toggle table of contents sidebar</div>
                <i class="icon">
                    <svg>
                        <use href="#svg-toc"></use>
                    </svg>
                </i>
            </label>
        </div>
    </header>
    <aside class="sidebar-drawer">
        <div class="sidebar-container">
            
            <div class="sidebar-sticky"><a class="sidebar-brand" href="../../">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo-light.svg" alt="Light Logo" />
    <img class="sidebar-logo only-dark" src="../../_static/logo-dark.svg" alt="Dark Logo" />
  </div>
  
  
</a>
<div class="sd-d-flex-row sd-align-major-spaced">
  <a class="github-button" href="https://github.com/jina-ai/finetuner" data-icon="octicon-star" data-show-count="true" aria-label="Star jina-ai/jina on GitHub" style="opacity: 0;">Star</a>
  
</div><form class="sidebar-search-container" method="get" action="../../search/" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
    <p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/how-it-works/">How Does it Work?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/design-principles/">Design Principles</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../walkthrough/">Walkthrough</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/basic-concepts/">Basic Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/login/">Login</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/create-training-data/">Prepare Training Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/choose-backbone/">Backbone Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/run-job/">Run Job</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/save-model/">Save Artifact</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/using-callbacks/">Using Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/integrate-with-jina/">Encode Documents</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Finetuning Tasks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../text_to_text/">Text-to-Text Search via BERT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../image_to_image/">Image-to-Image Search via ResNet50</a></li>
<li class="toctree-l1"><a class="reference internal" href="../text_to_image/">Text-to-Image Search via CLIP</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Multilingual Text-to-Image search with MultilingualCLIP</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/finetuner/">finetuner package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/finetuner.client/">finetuner.client package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/finetuner.client.client/">finetuner.client.client module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/finetuner.client.session/">finetuner.client.session module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.console/">finetuner.console module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.data/">finetuner.data module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.excepts/">finetuner.excepts module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.experiment/">finetuner.experiment module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.finetuner/">finetuner.finetuner module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.model/">finetuner.model module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/finetuner.run/">finetuner.run module</a></li>
</ul>
</li>
</ul>

    <p class="caption" role="heading"><span class="caption-text">Ecosystem</span></p>
    <ul>
        <li class="toctree-l1">
            <a class="reference external" href="https://docs.jina.ai">
                <img class="sidebar-ecosys-logo only-light-line" src="../../_static/search-light.svg">
                <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/search-dark.svg">
                Jina</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://cloud.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/hub-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/hub-dark.svg">
            Jina Hub</a></li>
        <li class="toctree-l1"><a class="reference internal" href="#">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/finetuner-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/finetuner-dark.svg">
            Finetuner</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://docarray.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/docarray-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/docarray-dark.svg">
            DocArray</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://clip-as-service.jina.ai">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/cas-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/cas-dark.svg">
            CLIP-as-service</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://github.com/jina-ai/jcloud">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/JCloud-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/JCloud-dark.svg">
            JCloud</a></li>
        <li class="toctree-l1"><a class="reference external" href="https://github.com/jina-ai/now">
            <img class="sidebar-ecosys-logo only-light-line" src="../../_static/now-light.svg">
            <img class="sidebar-ecosys-logo only-dark-line" src="../../_static/now-dark.svg">
            NOW</a></li>
    </ul>
</div>
</div>

            </div>
            
        </div>
    </aside>
    <div class="main">
        <div class="content">
            <div class="article-container">
                <a href="#" class="back-to-top muted-link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
                    </svg>
                    <span>Back to top</span>
                </a>
                <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
                        <button class="theme-toggle">
                            <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
                            <svg class="theme-icon-when-auto">
                                <use href="#svg-sun-half"></use>
                            </svg>
                            <svg class="theme-icon-when-dark">
                                <use href="#svg-moon"></use>
                            </svg>
                            <svg class="theme-icon-when-light">
                                <use href="#svg-sun"></use>
                            </svg>
                        </button>
                    </div>
                    <label class="toc-overlay-icon toc-content-icon"
                           for="__toc">
                        <div class="visually-hidden">Toggle table of contents sidebar</div>
                        <i class="icon">
                            <svg>
                                <use href="#svg-toc"></use>
                            </svg>
                        </i>
                    </label>
                </div>
                <article role="main">
                    <section class="tex2jax_ignore mathjax_ignore" id="multilingual-text-to-image-search-with-multilingualclip">
<h1>Multilingual Text-to-Image search with MultilingualCLIP<a class="headerlink" href="#multilingual-text-to-image-search-with-multilingualclip" title="Permalink to this headline">#</a></h1>
<p><a href="https://colab.research.google.com/drive/1N7iWZV0OunFZSLtsQxoazS808MPXhCwq?usp=sharing"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"></a></p>
<p>Most text-image models are only able to provide embeddings for text in a single language, typically English. Multilingual CLIP models, however, are models that have been trained on multiple different languages. This allows the model to produce similar embeddings for the same sentence in multiple different languages.</p>
<p>This guide will show you how to finetune a multilingual CLIP model for a text to image retrieval task in non-English languages.</p>
<p><em>Note, Check the runtime menu to be sure you are using a GPU/TPU instance, or this code will run very slowly.</em></p>
<section id="install">
<h2>Install<a class="headerlink" href="#install" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!pip install &#39;finetuner[full]&#39;
</pre></div>
</div>
</section>
<section id="task">
<h2>Task<a class="headerlink" href="#task" title="Permalink to this headline">#</a></h2>
<p>We‚Äôll be fine-tuning multilingual CLIP on the electronics section of the <a class="reference external" href="https://xmrec.github.io/data/de/">German XMarket dataset</a>, which contains images and descriptions of electronics products in German.</p>
<p>Each product in the dataset contains several attributes, we will be making use of the image and category attributes to create a <a class="reference external" href="https://docarray.jina.ai/fundamentals/document/#document"><code class="docutils literal notranslate"><span class="pre">Document</span></code></a> containing two <a class="reference external" href="https://docarray.jina.ai/fundamentals/document/nested/#nested-structure">chunks</a>, one containing the image and another containing the category of the product.</p>
</section>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h2>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">xmarket-de-electronics</span></code> dataset, which we have already pre-processed and made available on the Jina AI Cloud. You can access it using <code class="docutils literal notranslate"><span class="pre">DocArray.pull</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">finetuner</span>
<span class="kn">from</span> <span class="nn">docarray</span> <span class="kn">import</span> <span class="n">DocumentArray</span><span class="p">,</span> <span class="n">Document</span>

<span class="n">finetuner</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_data</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s1">&#39;xmarket-de-electronics-train-data&#39;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">eval_data</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s1">&#39;xmarket-de-electronics-test-data&#39;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">query_data</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s1">&#39;xmarket-de-electronics-query-data&#39;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">index_data</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="s1">&#39;xmarket-de-electronics-index-data&#39;</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">train_data</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="backbone-model">
<h2>Backbone Model<a class="headerlink" href="#backbone-model" title="Permalink to this headline">#</a></h2>
<p>Currently, we only support one multilingual CLIP model. This model is the <code class="docutils literal notranslate"><span class="pre">xlm-roberta-base-ViT-B-32</span></code> from <a class="reference external" href="https://github.com/mlfoundations/open_clip">open-clip</a>, which has been trained on the <a class="reference external" href="https://github.com/LAION-AI/laion5B-paper"><code class="docutils literal notranslate"><span class="pre">laion5b</span></code> dataset</a>.</p>
</section>
<section id="fine-tuning">
<h2>Fine-tuning<a class="headerlink" href="#fine-tuning" title="Permalink to this headline">#</a></h2>
<p>Now that our data has been prepared, we can start our fine-tuning run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">finetuner</span>
<span class="kn">from</span> <span class="nn">finetuner.callback</span> <span class="kn">import</span> <span class="n">EvaluationCallback</span><span class="p">,</span> <span class="n">WandBLogger</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s1">&#39;xlm-roberta-base-ViT-B-32::laion5b_s13b_b90k&#39;</span><span class="p">,</span>
    <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
    <span class="n">eval_data</span><span class="o">=</span><span class="n">eval_data</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;CLIPLoss&#39;</span><span class="p">,</span>
    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span>
        <span class="n">EvaluationCallback</span><span class="p">(</span>
            <span class="n">query_data</span><span class="o">=</span><span class="s1">&#39;xmarket-de-electronics-query-data&#39;</span><span class="p">,</span>
            <span class="n">index_data</span><span class="o">=</span><span class="s1">&#39;xmarket-de-electronics-index-data&#39;</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="s1">&#39;clip-text&#39;</span><span class="p">,</span>
            <span class="n">index_model</span><span class="o">=</span><span class="s1">&#39;clip-vision&#39;</span>
        <span class="p">),</span>
        <span class="n">WandBLogger</span><span class="p">(),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Let‚Äôs understand what this piece of code does:</p>
<ul class="simple">
<li><p>We start with providing <code class="docutils literal notranslate"><span class="pre">model</span></code>, names of training and evaluation data.</p></li>
<li><p>We also provide some hyper-parameters such as number of <code class="docutils literal notranslate"><span class="pre">epochs</span></code> and a <code class="docutils literal notranslate"><span class="pre">learning_rate</span></code>.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">CLIPLoss</span></code> to optimize the CLIP model.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">finetuner.callback.EvaluationCallback</span></code> for evaluation.</p></li>
<li><p>We then use the <code class="docutils literal notranslate"><span class="pre">finetuner.callback.WandBLogger</span></code> to display our results.</p></li>
</ul>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">#</a></h2>
<p>Now that we‚Äôve created a run, let‚Äôs see its status. You can monitor the run by checking the status - <code class="docutils literal notranslate"><span class="pre">run.status()</span></code> - and the logs - <code class="docutils literal notranslate"><span class="pre">run.logs()</span></code> or <code class="docutils literal notranslate"><span class="pre">run.stream_logs()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># note, the fine-tuning might takes 20~ minutes</span>
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">stream_logs</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</pre></div>
</div>
<!-- #region -->
<p>Since some runs might take up to several hours/days, it‚Äôs important to know how to reconnect to Finetuner and retrieve your run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">finetuner</span>

<span class="n">finetuner</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>You can continue monitoring the run by checking the status - <code class="docutils literal notranslate"><span class="pre">finetuner.run.Run.status()</span></code> or the logs <code class="docutils literal notranslate"><span class="pre">finetuner.run.Run.logs()</span></code>.</p>
<!-- #endregion -->
<!-- #region -->
</section>
<section id="evaluating">
<h2>Evaluating<a class="headerlink" href="#evaluating" title="Permalink to this headline">#</a></h2>
<p>Once the run is finished, the metrics calculated by the <code class="xref py py-class docutils literal notranslate"><span class="pre">EvaluationCallback</span></code> are plotted using the <code class="xref py py-class docutils literal notranslate"><span class="pre">WandBLogger</span></code> callback. These plots can be accessed using the link provided in the logs once finetuning starts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>           INFO     Finetuning ... 
wandb: Currently logged <span class="k">in</span> as: anony-mouse-448424. Use <span class="sb">`</span>wandb login --relogin<span class="sb">`</span> to force relogin
wandb: Tracking run with wandb version <span class="m">0</span>.13.5
wandb: Run data is saved locally <span class="k">in</span> &lt;path-to-file&gt;
wandb: Run <span class="sb">`</span>wandb offline<span class="sb">`</span> to turn off syncing.
wandb: Syncing run ancient-galaxy-2
wandb:  View project at &lt;link-to-project&gt;
wandb:  View run at &lt;link-to-run&gt;
</pre></div>
</div>
<p>The generated plots should look like this:</p>
<p><img alt="WandB-mclip" src="../../_images/WandB-mclip.png" /></p>
<!-- #endregion -->
</section>
<section id="saving">
<h2>Saving<a class="headerlink" href="#saving" title="Permalink to this headline">#</a></h2>
<p>After the run has finished successfully, you can download the tuned model on your local machine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">artifact</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">save_artifact</span><span class="p">(</span><span class="s1">&#39;mclip-model&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="inference">
<h2>Inference<a class="headerlink" href="#inference" title="Permalink to this headline">#</a></h2>
<p>Now you saved the <code class="docutils literal notranslate"><span class="pre">artifact</span></code> into your host machine,
let‚Äôs use the fine-tuned model to encode a new <code class="docutils literal notranslate"><span class="pre">Document</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">text_da</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="p">([</span><span class="n">Document</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;setwas Text zum Codieren&#39;</span><span class="p">)])</span>
<span class="n">image_da</span> <span class="o">=</span> <span class="n">DocumentArray</span><span class="p">([</span><span class="n">Document</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s1">&#39;https://upload.wikimedia.org/wikipedia/commons/4/4e/Single_apple.png&#39;</span><span class="p">)])</span>

<span class="n">mclip_text_encoder</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">artifact</span><span class="o">=</span><span class="n">artifact</span><span class="p">,</span> <span class="n">select_model</span><span class="o">=</span><span class="s1">&#39;clip-text&#39;</span><span class="p">)</span>
<span class="n">mclip_image_encoder</span> <span class="o">=</span> <span class="n">finetuner</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">artifact</span><span class="o">=</span><span class="n">artifact</span><span class="p">,</span> <span class="n">select_model</span><span class="o">=</span><span class="s1">&#39;clip-vision&#39;</span><span class="p">)</span>

<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">mclip_text_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">text_da</span><span class="p">)</span>
<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">mclip_image_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_da</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">text_da</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">image_da</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<!-- #region -->
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">(</span><span class="m">1</span>, <span class="m">512</span><span class="o">)</span>
<span class="o">(</span><span class="m">1</span>, <span class="m">512</span><span class="o">)</span>
</pre></div>
</div>
<div class="admonition-what-is-select-model admonition">
<p class="admonition-title">what is select_model?</p>
<p>When fine-tuning CLIP, we are fine-tuning the CLIPVisionEncoder and CLIPTextEncoder in parallel.
The artifact contains two models: <code class="docutils literal notranslate"><span class="pre">clip-vision</span></code> and <code class="docutils literal notranslate"><span class="pre">clip-text</span></code>.
The parameter <code class="docutils literal notranslate"><span class="pre">select_model</span></code> tells finetuner which model to use for inference, in the above example,
we use <code class="docutils literal notranslate"><span class="pre">clip-text</span></code> to encode a Document with text content.</p>
</div>
<div class="admonition-inference-with-onnx admonition">
<p class="admonition-title">Inference with ONNX</p>
<p>In case you set <code class="docutils literal notranslate"><span class="pre">to_onnx=True</span></code> when calling <code class="docutils literal notranslate"><span class="pre">finetuner.fit</span></code> function,
please use <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">=</span> <span class="pre">finetuner.get_model(artifact,</span> <span class="pre">is_onnx=True)</span></code></p>
</div>
<!-- #endregion -->
</section>
<section id="before-and-after">
<h2>Before and After<a class="headerlink" href="#before-and-after" title="Permalink to this headline">#</a></h2>
<p>We can directly compare the results of our fine-tuned model with an untrained multilingual clip model by displaying the matches each model has for the same query, while the differences between the results of the two models are quite subtle for some queries, the examples below clearly show that finetuning increses the quality of the search results:</p>
<!-- #region -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">finetuner</span> <span class="kn">import</span> <span class="n">build_model</span>

<span class="n">pt_query</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">query_data</span><span class="p">)</span>
<span class="n">pt_index</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">index_data</span><span class="p">)</span>

<span class="n">ft_query</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">query_data</span><span class="p">)</span>
<span class="n">ft_index</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">index_data</span><span class="p">)</span>

<span class="n">zero_shot_text_encoder</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;xlm-roberta-base-ViT-B-32::laion5b_s13b_b90k&#39;</span><span class="p">,</span>
    <span class="n">select_model</span> <span class="o">=</span> <span class="s1">&#39;clip_text&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">zero_shot_image_encoder</span> <span class="o">=</span> <span class="n">build_model</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;xlm-roberta-base-ViT-B-32::laion5b_s13b_b90k&#39;</span><span class="p">,</span>
    <span class="n">select_model</span> <span class="o">=</span> <span class="s1">&#39;clip_vision&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">zero_shot_text_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pt_query</span><span class="p">)</span>
<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">zero_shot_image_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pt_index</span><span class="p">)</span>

<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">mclip_text_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ft_query</span><span class="p">)</span>
<span class="n">finetuner</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">mclip_image_encoder</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ft_index</span><span class="p">)</span>

<span class="n">pt_query</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pt_index</span><span class="p">)</span>
<span class="n">ft_query</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ft_index</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;results for query: &quot;externe mikrofone (external microphone)&quot; using a zero-shot model (top) and the fine-tuned model (bottom)&#39;</span><span class="p">)</span>
<span class="n">pt_query</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_image_sprites</span><span class="p">()</span>
<span class="n">ft_query</span><span class="p">[</span><span class="mi">72</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_image_sprites</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;results for query: &quot;prozessorl√ºfter (processor fan)&quot; using a zero-shot model (top) and the fine-tuned model (bottom)&#39;</span><span class="p">)</span>
<span class="n">pt_query</span><span class="p">[</span><span class="mi">189</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_image_sprites</span><span class="p">()</span>
<span class="n">ft_query</span><span class="p">[</span><span class="mi">189</span><span class="p">]</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_image_sprites</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>results <span class="k">for</span> query: <span class="s2">&quot;externe mikrofone (external microphone)&quot;</span> using a zero-shot model <span class="o">(</span>top<span class="o">)</span> and the fine-tuned model <span class="o">(</span>bottom<span class="o">)</span>
</pre></div>
</div>
<p><img alt="mclip-example-pt-1" src="../../_images/mclip-example-pt-1.png" />
<img alt="mclip-example-ft-1" src="../../_images/mclip-example-ft-1.png" /></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>results <span class="k">for</span> query: <span class="s2">&quot;prozessorl√ºfter (processor fan)&quot;</span> using a zero-shot model <span class="o">(</span>top<span class="o">)</span> and the fine-tuned model <span class="o">(</span>bottom<span class="o">)</span>
</pre></div>
</div>
<p><img alt="mclip-example-pt-2" src="../../_images/mclip-example-pt-2.png" />
<img alt="mclip-example-ft-2" src="../../_images/mclip-example-ft-2.png" /></p>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</section>
</section>

                </article>
            </div>
            <footer>
                
                <div class="related-pages">
                    <a class="next-page" href="../../api/finetuner/">
                        <div class="page-info">
                            <div class="context">
                                <span>Next</span>
                            </div>
                            <div class="title">finetuner package</div>
                        </div>
                        <svg class="furo-related-icon">
                            <use href="#svg-arrow-right"></use>
                        </svg>
                    </a>
                    <a class="prev-page" href="../text_to_image/">
                        <svg class="furo-related-icon">
                            <use href="#svg-arrow-right"></use>
                        </svg>
                        <div class="page-info">
                            <div class="context">
                                <span>Previous</span>
                            </div>
                            
                            <div class="title">Text-to-Image Search via CLIP</div>
                            
                        </div>
                    </a>
                </div>
                <div class="bottom-of-page">
                    <div class="left-details">
                        <div class="copyright">
                            Copyright &#169; Jina AI Limited. All rights reserved.
                        </div><div class="last-updated">
                            Last updated on Nov 25, 2022</div>
                    </div>
                    <div class="right-details">
                        <div class="social-btns">
                            <a class='social-btn' href="https://github.com/jina-ai/finetuner/" aria-label="GitHub"
                               target="_blank" rel="noreferrer"> <i class="fab fa-github"></i></a>
                            <a class='social-btn' href="https://slack.jina.ai" aria-label="Slack" target="_blank"
                               rel="noreferrer"> <i class="fab fa-slack"></i></a>
                            <a class='social-btn' href="https://youtube.com/c/jina-ai" aria-label="YouTube"
                               target="_blank" rel="noreferrer"> <i class="fab fa-youtube"></i></a>
                            <a class='social-btn' href="https://twitter.com/JinaAI_" aria-label="Twitter"
                               target="_blank" rel="noreferrer"> <i class="fab fa-twitter"></i></a>
                            <a class='social-btn' href="https://www.linkedin.com/company/jinaai/" aria-label="LinkedIn"
                               target="_blank" rel="noreferrer"> <i class="fab fa-linkedin"></i></a>
                        </div>
                    </div>
                </div>
                
            </footer>
        </div>
        <aside class="toc-drawer">
            
            
            <div class="toc-sticky toc-scroll">
                <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
                </div>
                <div class="toc-tree-container">
                    <div class="toc-tree">
                        <ul>
<li><a class="reference internal" href="#">Multilingual Text-to-Image search with MultilingualCLIP</a><ul>
<li><a class="reference internal" href="#install">Install</a></li>
<li><a class="reference internal" href="#task">Task</a></li>
<li><a class="reference internal" href="#data">Data</a></li>
<li><a class="reference internal" href="#backbone-model">Backbone Model</a></li>
<li><a class="reference internal" href="#fine-tuning">Fine-tuning</a></li>
<li><a class="reference internal" href="#monitoring">Monitoring</a></li>
<li><a class="reference internal" href="#evaluating">Evaluating</a></li>
<li><a class="reference internal" href="#saving">Saving</a></li>
<li><a class="reference internal" href="#inference">Inference</a></li>
<li><a class="reference internal" href="#before-and-after">Before and After</a></li>
</ul>
</li>
</ul>

                    </div>
                </div>
            </div>
            
            
        </aside>

        <qa-bot
            token="vizI4XaM1li8kQW2kQOiiBjtk02hzBDl0Em8lBjpzAKsjhX_z03mix_i3wKpiA=="
            theme="infer"
            target="_self"
            orientation="bottom-right"
            title="Finetuner"
            description="Task-oriented finetuning for better embeddings on neural search"
            show-tip>
          <template>
            <dl>
             <dt>You can ask questions about our docs. Try:</dt>
             <dd>What is Finetuner?</dd>
             <dd>How does Finetuner Work?</dd>
             <dd>What makes Finetuner unique?</dd>
            </dl>
          </template>
          <template slot="texts">
            <span for="tip">Hi there üëã
         Ask our docs!</span>
            <span for="unknownAnswerText">üòµ‚Äçüí´ I'm sorry but I don't know the answer.</span>
          </template>
        </qa-bot>
</div>
<img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=e0caedb8-a833-4e85-983d-d3394a5f16d2" /><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qabot"></script>
    <script src="../../_static/source-in-links.js"></script>
    </body>
</html>